<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ç®¡ç† | ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼†æŠ•ç¨¿ã‚®ãƒ£ãƒ©ãƒªãƒ¼</title>
    <style>
      body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Hiragino Kaku Gothic ProN', 'Yu Gothic', Meiryo, sans-serif; background:#0f1115; color:#e5e7eb; margin:0; padding-bottom: 60px; }
      .wrap { max-width: 900px; margin: 32px auto; padding: 0 16px; }
      h1 { font-size: 24px; margin: 0 0 24px; text-align: center; }
      h2 { font-size: 20px; margin: 32px 0 16px; border-bottom: 2px solid #262a34; padding-bottom: 8px; }
      .card { background:#16181f; border:1px solid #262a34; border-radius:12px; padding:20px; margin: 16px 0; }
      label { display:block; margin:12px 0 6px; font-weight:600; font-size: 14px; }
      input[type="text"], input[type="password"], input[type="date"], input[type="number"], textarea { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #303544; background:#0f1115; color:#e5e7eb; font-family: inherit; }
      textarea { min-height: 80px; resize: vertical; }
      .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom: 12px; }
      .row-3 { display:grid; grid-template-columns: 2fr 1fr 1fr; gap:12px; margin-bottom: 12px; }
      button { cursor:pointer; padding:10px 16px; border-radius:10px; border:1px solid transparent; color:#0b1220; background: linear-gradient(135deg,#14a3d6,#0ea5e9); font-weight:700; transition: transform 0.2s ease; }
      button:hover { transform: translateY(-1px); }
      button.secondary { background: #262a34; color: #e5e7eb; border: 1px solid #303544; }
      button.danger { background: #ef4444; color: white; }
      .muted { color:#9aa1ae; font-size: 13px; margin-top: 8px; }
      .success { color:#34d399; }
      .error { color:#f87171; }
      .hidden { display:none; }
      .ranking-row { background: #1a1c24; padding: 12px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #262a34; }
      .post-row { background: #1a1c24; padding: 12px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #262a34; position: relative; }
      .remove-btn { position: absolute; top: 8px; right: 8px; padding: 4px 10px; font-size: 12px; }
      .btn-group { display: flex; gap: 12px; margin-top: 16px; align-items: center; flex-wrap: wrap; }
      .note-box { background: rgba(34,193,241,0.1); border: 1px solid rgba(34,193,241,0.3); border-radius: 8px; padding: 12px; margin: 16px 0; }
      .preview-indicator { display: inline-flex; align-items: center; gap: 6px; font-size: 13px; color: #9aa1ae; }
      .preview-indicator.up { color: #3b82f6; }
      .preview-indicator.same { color: #ffffff; }
      .preview-indicator.down { color: #ef4444; }
      .preview-indicator.new { color: #eab308; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>ç®¡ç†ç”»é¢ | ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼†æŠ•ç¨¿ã‚®ãƒ£ãƒ©ãƒªãƒ¼</h1>

      <div id="login" class="card">
        <p class="muted">ç®¡ç†ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
        <label for="pw">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input id="pw" type="password" placeholder="********" />
        <div class="btn-group">
          <button id="btn-login">ãƒ­ã‚°ã‚¤ãƒ³</button>
          <span id="login-msg" class="muted"></span>
        </div>
      </div>

      <div id="editor" class="card hidden">
        <div class="note-box">
          <p style="margin: 0; font-size: 14px;">GitHubã«åæ˜ ã™ã‚‹ãŸã‚ã€æ›´æ–°æ™‚ã«GitHub Personal Access Token (PAT) ãŒå¿…è¦ã§ã™ã€‚ãƒˆãƒ¼ã‚¯ãƒ³ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚</p>
        </div>

        <div class="row">
          <div>
            <label for="date">å¯¾è±¡æ—¥ä»˜ï¼ˆYYYY-MM-DDï¼‰</label>
            <input id="date" type="date" />
          </div>
          <div>
            <label for="token">GitHubãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆrepoæ¨©é™ï¼‰</label>
            <input id="token" type="password" placeholder="ghp_..." />
          </div>
        </div>

        <h2>ğŸ“Š ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç®¡ç†ï¼ˆ1ä½ï½10ä½ï¼‰</h2>
        <p class="muted">å‰æ—¥é †ä½ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€è‡ªå‹•ã§çŸ¢å°ï¼ˆâ†‘â†“â†ï¼‰ãŒè¨ˆç®—ã•ã‚Œã¾ã™ã€‚æ–°è¦ã®å ´åˆã¯ç©ºæ¬„ã«ã—ã¦ãã ã•ã„ã€‚<br>â€» <strong>åŒä¸€é †ä½ã®å ´åˆ</strong>: æ°åæ¬„ã«ã€Œå±±ç”°å¤ªéƒ, ä½è—¤èŠ±å­ã€ã€å‰æ—¥é †ä½æ¬„ã«ã€Œ3, 4ã€ã®ã‚ˆã†ã«ã€Œ,ã€ã§åŒºåˆ‡ã£ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚å„äººã«å¯¾å¿œã™ã‚‹çŸ¢å°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>

        <div id="rankings-form">
          <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
        </div>

        <h2>ğŸ“¸ æ˜¨æ—¥ã®ãƒˆãƒƒãƒ—3æŠ•ç¨¿</h2>
        <p class="muted">æ˜¨æ—¥ã ã‘ã®ã„ã„ã­æ•°ãƒˆãƒƒãƒ—3ã‚’å…¥åŠ›ã—ã¾ã™ï¼ˆæŠ•ç¨¿è€…åã¨ã„ã„ã­æ•°ã®ã¿ï¼‰ã€‚<br>â€» é€šç®—ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¨ã¯åˆ¥ã«ã€1æ—¥é™å®šã®äººæ°—æŠ•ç¨¿ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚</p>

        <div id="daily-posts-form">
          <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
        </div>

        <div class="btn-group" style="margin-top: 32px;">
          <button id="btn-save">GitHubã«ä¿å­˜</button>
          <span id="msg" class="muted"></span>
        </div>
      </div>
    </div>

    <script>
      // å…±æœ‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
      const ADMIN_PASSWORD = 'tsubox-admin';
      const OWNER = 'daiki-ike';
      const REPO = 'tsubox-event-preview';
      const BRANCH = 'main';
      const RANKINGS_FILE = 'rankings.json';
      const DAILY_POSTS_FILE = 'daily-top3.json';

      const $ = (id) => document.getElementById(id);
      const login = $('login');
      const editor = $('editor');
      const loginMsg = $('login-msg');
      const msg = $('msg');

      // æ—¢å®šã®æ—¥ä»˜=ä»Šæ—¥ï¼ˆJSTï¼‰
      (function setDefaultDate(){
        const now = Date.now();
        const jst = new Date(now + 9*60*60*1000);
        const y = jst.getUTCFullYear();
        const m = String(jst.getUTCMonth()+1).padStart(2,'0');
        const d = String(jst.getUTCDate()).padStart(2,'0');
        $('date').value = `${y}-${m}-${d}`;
      })();

      $('btn-login').addEventListener('click', () => {
        if ($('pw').value === ADMIN_PASSWORD) {
          login.classList.add('hidden');
          editor.classList.remove('hidden');
          loginMsg.textContent = '';
          initForms();
        } else {
          loginMsg.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚';
          loginMsg.className = 'error';
        }
      });

      function b64encode(str){return btoa(unescape(encodeURIComponent(str)));}
      function b64decode(str){return decodeURIComponent(escape(atob(str)));}

      async function fetchFile(token, filepath){
        const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${filepath}?ref=${BRANCH}`;
        const res = await fetch(url, {
          headers: {
            'Accept':'application/vnd.github+json',
            'X-GitHub-Api-Version':'2022-11-28',
            ...(token?{Authorization:`token ${token}`}:{})
          }
        });
        if (!res.ok) return { sha: null, data: null };
        const j = await res.json();
        const content = j.content ? b64decode(j.content) : '{}';
        return { sha: j.sha, data: JSON.parse(content) };
      }

      async function saveFile(token, filepath, data, baseSha, commitMessage){
        const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${filepath}`;
        const body = {
          message: commitMessage,
          content: b64encode(JSON.stringify(data, null, 2) + '\n'),
          branch: BRANCH,
          ...(baseSha && {sha: baseSha})
        };
        const res = await fetch(url, {
          method:'PUT',
          headers:{
            'Accept':'application/vnd.github+json',
            'X-GitHub-Api-Version':'2022-11-28',
            'Authorization':`token ${token}`
          },
          body: JSON.stringify(body)
        });
        if (!res.ok) throw new Error(`GitHubä¿å­˜å¤±æ•—: ${filepath}`);
        return await res.json();
      }

      // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ ã®åˆæœŸåŒ–
      function initForms() {
        const rankingsForm = $('rankings-form');
        rankingsForm.innerHTML = '';

        for (let i = 1; i <= 10; i++) {
          const div = document.createElement('div');
          div.className = 'ranking-row';
          div.innerHTML = `
            <div class="row-3">
              <div>
                <label for="name-${i}">${i}ä½ æ°å</label>
                <input type="text" id="name-${i}" placeholder="ä¾‹: å±±ç”°å¤ªéƒ" />
              </div>
              <div>
                <label for="prev-${i}">å‰æ—¥é †ä½</label>
                <input type="number" id="prev-${i}" min="1" max="20" placeholder="ä¾‹: 2" />
              </div>
              <div style="display: flex; align-items: flex-end;">
                <span id="indicator-${i}" class="preview-indicator"></span>
              </div>
            </div>
          `;
          rankingsForm.appendChild(div);

          // å‰æ—¥é †ä½ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰çŸ¢å°ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
          $(`prev-${i}`).addEventListener('input', () => updateIndicator(i));
        }

        // æ˜¨æ—¥ã®ãƒˆãƒƒãƒ—3æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã®åˆæœŸåŒ–
        const dailyPostsForm = $('daily-posts-form');
        dailyPostsForm.innerHTML = '';

        for (let i = 1; i <= 3; i++) {
          const div = document.createElement('div');
          div.className = 'ranking-row';
          div.innerHTML = `
            <div class="row">
              <div>
                <label for="daily-name-${i}">${i}ä½ æŠ•ç¨¿è€…å</label>
                <input type="text" id="daily-name-${i}" placeholder="ä¾‹: å±±ç”°å¤ªéƒ" />
              </div>
              <div>
                <label for="daily-likes-${i}">ã„ã„ã­æ•°</label>
                <input type="number" id="daily-likes-${i}" min="0" placeholder="ä¾‹: 245" />
              </div>
            </div>
          `;
          dailyPostsForm.appendChild(div);
        }
      }

      function updateIndicator(rank) {
        const prevRank = parseInt($(`prev-${rank}`).value);
        const indicator = $(`indicator-${rank}`);

        if (isNaN(prevRank) || prevRank === '') {
          indicator.textContent = 'NEW';
          indicator.className = 'preview-indicator new';
        } else {
          const diff = prevRank - rank;
          if (diff > 0) {
            indicator.textContent = 'â†‘ ãƒ©ãƒ³ã‚¯ã‚¢ãƒƒãƒ—';
            indicator.className = 'preview-indicator up';
          } else if (diff < 0) {
            indicator.textContent = 'â†“ ãƒ©ãƒ³ã‚¯ãƒ€ã‚¦ãƒ³';
            indicator.className = 'preview-indicator down';
          } else {
            indicator.textContent = 'â† å¤‰å‹•ãªã—';
            indicator.className = 'preview-indicator same';
          }
        }
      }

      $('btn-save').addEventListener('click', async () => {
        msg.textContent = 'ä¿å­˜ä¸­â€¦';
        msg.className = 'muted';

        const token = $('token').value.trim();
        if (!token) {
          msg.textContent = 'GitHubãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
          msg.className='error';
          return;
        }

        const date = $('date').value;
        if (!date) {
          msg.textContent = 'æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
          msg.className='error';
          return;
        }

        try {
          // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã®åé›†
          const rankings = [];
          for (let i = 1; i <= 10; i++) {
            const name = $(`name-${i}`).value.trim();
            if (!name) continue;

            const prevRankValue = $(`prev-${i}`).value.trim();
            const prevRank = prevRankValue ? parseInt(prevRankValue) : null;

            rankings.push({
              rank: i,
              name: name,
              prevRank: prevRank
            });
          }

          if (rankings.length === 0) {
            msg.textContent = 'å°‘ãªãã¨ã‚‚1åã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
            msg.className = 'error';
            return;
          }

          // rankings.jsonã‚’ä¿å­˜
          const rankingsFile = await fetchFile(token, RANKINGS_FILE);
          const rankingsData = rankingsFile.data || {};
          rankingsData[date] = rankings;
          await saveFile(token, RANKINGS_FILE, rankingsData, rankingsFile.sha, `Update rankings for ${date}`);

          // æ˜¨æ—¥ã®ãƒˆãƒƒãƒ—3æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã®åé›†
          const dailyPosts = [];
          for (let i = 1; i <= 3; i++) {
            const name = $(`daily-name-${i}`).value.trim();
            const likes = $(`daily-likes-${i}`).value.trim();

            if (name && likes) {
              dailyPosts.push({
                rank: i,
                name: name,
                likes: parseInt(likes)
              });
            }
          }

          // daily-top3.jsonã‚’ä¿å­˜
          if (dailyPosts.length > 0) {
            const dailyPostsFile = await fetchFile(token, DAILY_POSTS_FILE);
            const dailyPostsData = dailyPostsFile.data || {};
            dailyPostsData[date] = dailyPosts;
            await saveFile(token, DAILY_POSTS_FILE, dailyPostsData, dailyPostsFile.sha, `Update daily top3 posts for ${date}`);
          }

          msg.textContent = 'âœ“ ä¿å­˜ã—ã¾ã—ãŸï¼ï¼ˆæ•°åç§’å¾Œã«ã‚µã‚¤ãƒˆã¸åæ˜ ï¼‰';
          msg.className='success';
        } catch (e) {
          console.error(e);
          msg.textContent = `ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}`;
          msg.className='error';
        }
      });
    </script>
  </body>
</html>
